#include <exploit/exploit.h>

int checkm8Reset(dfu_device_t *dfuDevice)
{
    return 0;
}

int checkm8HeapSpray(dfu_device_t *dfuDevice)
{
    return 0;
}

int checkm8Trigger(dfu_device_t *dfuDevice)
{
    return 0;
}

int checkm8SendPayload(dfu_device_t *dfuDevice)
{
    return 0;
}

int checkm8Done(dfu_device_t *dfuDevice)
{
    return isSerialNumberPwned(getDeviceSerialNumber(dfuDevice->service));
}

int exploit()
{
    device_t device;
    // TODO: look for devices in different modes
    int ret = findDevice(&device, false);
    if (ret == -1)
    {
        return -1;
    }

    if (device.mode == MODE_NORMAL) {
        LOG(LOG_SUCCESS, "Found device in normal mode");
        LOG(LOG_INFO, "Placing device into recovery mode");
        LOG(LOG_DEBUG, "Device serial number: %s", device.serialNumber);
        if (enter_recovery() != 0) {
            LOG(LOG_ERROR, "Failed to place device with udid %s into recovery mode", device.serialNumber);
            return -1;
        }
        LOG(LOG_INFO, "Waiting for device to enter recovery mode");
        if (waitForDeviceInMode(&device, MODE_RECOVERY, 20) != 0) {
            LOG(LOG_ERROR, "Device with udid %s failed to enter recovery mode", device.serialNumber);
            return -1;
        }
        LOG(LOG_SUCCESS, "Device entered recovery mode successfully!", device.serialNumber);
    }

    if (device.mode == MODE_RECOVERY) {
        // TODO: DFU helper
        LOG(LOG_INFO, "Please put device into DFU mode manually");
        LOG(LOG_INFO, "Waiting for device to enter DFU mode");
        if (waitForDeviceInMode(&device, MODE_DFU, 30) != 0) {
            LOG(LOG_FATAL, "Could not find device in DFU mode after 30 seconds", device.serialNumber);
            return -1;
        }
        LOG(LOG_SUCCESS, "Device entered DFU mode successfully!");
    }

    dfu_device_t dfuDevice;
    // TODO: Check if device is already in pwned DFU mode inside initDFUDevice()
    if (isSerialNumberPwned(device.serialNumber) != 0)
    {
        LOG(LOG_ERROR, "Device is already in pwned DFU mode, not performing exploit");
        return 1;
    }
    else
    {
        dfuDevice = initDFUDevice(device);
        LOG(LOG_DEBUG, "Device serial number: %s", device.serialNumber); // TODO: add char *serialNumber to dfu_device_t
    }

    // dfu_device_t dfuDevice = initDFUDevice(device);

    // LOG(LOG_INFO, "Starting exploit");
    // LOG(LOG_INFO, "Initial checkm8 spray");
    // ret = checkm8HeapSpray(&dfuDevice);
    // LOG(LOG_INFO, "Triggering UaF");
    // ret = checkm8Trigger(&dfuDevice);
    // LOG(LOG_INFO, "Sending payload");
    // ret = checkm8SendPayload(&dfuDevice);
    // LOG(LOG_INFO, "Done?");
    // int pwned = checkm8Done(&dfuDevice);
    // if (pwned == 0)
    // {
    //     LOG(LOG_SUCCESS, "Exploit success, device is now in pwned DFU mode");
    // }
    // else if (pwned == 1)
    // {
    //     LOG(LOG_FATAL, "ERROR: Exploit failed, device is not in pwned DFU mode");
    // }
    // else
    // {
    //     LOG(LOG_FATAL, "ERROR: Could not check if device is in pwned DFU mode");
    // }

    return 0;
}
