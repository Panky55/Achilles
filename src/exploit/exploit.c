#include <exploit/exploit.h>

int exploit()
{
    io_service_t device = findDevice();
    if (device == -1) {
        return -1;
    }
    dfu_device_t dfuDevice;
    if (isPwned(getDeviceSerialNumber(device)) != 0) {
        LOG(LOG_ERROR, "Device is already in pwned DFU mode, not performing exploit");
        return 1;
    } else {
        dfuDevice = initDevice(device);
    }
    
    LOG(LOG_INFO, "Starting exploit");
    LOG(LOG_INFO, "Initial checkm8 spray");
    LOG(LOG_INFO, "Triggering UaF");
    LOG(LOG_INFO, "Sending payload");
    LOG(LOG_INFO, "Done?");
    int pwned = isPwned(getDeviceSerialNumber(device));
    if (pwned == 0) {
        LOG(LOG_SUCCESS, "Exploit success, device is now in pwned DFU mode");
    } else if (pwned == 1) {
        LOG(LOG_FATAL, "ERROR: Exploit failed, device is not in pwned DFU mode");
    } else {
        LOG(LOG_FATAL, "ERROR: Could not check if device is in pwned DFU mode");
    }

    return 0;
}
