#include <exploit/exploit.h>

int checkm8Reset(dfu_device_t *dfuDevice)
{
    return 0;
}

int checkm8HeapSpray(dfu_device_t *dfuDevice)
{
    return 0;
}

int checkm8Trigger(dfu_device_t *dfuDevice)
{
    return 0;
}

int checkm8SendPayload(dfu_device_t *dfuDevice)
{
    return 0;
}

int checkm8Done(dfu_device_t *dfuDevice)
{
    return isSerialNumberPwned(getDeviceSerialNumber(dfuDevice->service));
}

int exploit()
{
    io_service_t device = findDevice();
    if (device == -1)
    {
        return -1;
    }
    dfu_device_t dfuDevice;
    if (isSerialNumberPwned(getDeviceSerialNumber(device)) != 0)
    {
        LOG(LOG_ERROR, "Device is already in pwned DFU mode, not performing exploit");
        return 1;
    }
    else
    {
        dfuDevice = initDevice(device);
    }

    int ret;

    LOG(LOG_INFO, "Starting exploit");
    LOG(LOG_INFO, "Initial checkm8 spray");
    ret = checkm8HeapSpray(&dfuDevice);
    LOG(LOG_INFO, "Triggering UaF");
    ret = checkm8Trigger(&dfuDevice);
    LOG(LOG_INFO, "Sending payload");
    ret = checkm8SendPayload(&dfuDevice);
    LOG(LOG_INFO, "Done?");
    int pwned = checkm8Done(&dfuDevice);
    if (pwned == 0)
    {
        LOG(LOG_SUCCESS, "Exploit success, device is now in pwned DFU mode");
    }
    else if (pwned == 1)
    {
        LOG(LOG_FATAL, "ERROR: Exploit failed, device is not in pwned DFU mode");
    }
    else
    {
        LOG(LOG_FATAL, "ERROR: Could not check if device is in pwned DFU mode");
    }

    return 0;
}
