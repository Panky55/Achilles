#include <exploit/exploit.h>

// 0x1 - DFU_DNLOAD
// 0x2 - DFU_UPLOAD
// 0x3 - DFU_GETSTATUS
// 0x4 - DFU_CLRSTATUS
// 0x5 - DFU_GETSTATE
// 0x6 - DFU_ABORT

int checkm8Reset(dfu_device_t *dfuDevice)
{
    return 0;
}

int checkm8HeapSpray(dfu_device_t *dfuDevice)
{
    return 0;
}

int checkm8Trigger(dfu_device_t *dfuDevice)
{
    return 0;
}

int checkm8SendPayload(dfu_device_t *dfuDevice)
{
    return 0;
}

int checkm8Done(device_t *device)
{
    return isSerialNumberPwned(getDeviceSerialNumber(&device->handle));
}

int exploit()
{
    device_t device;
    // TODO: look for devices in different modes
    int ret = findDevice(&device);
    if (ret == -1)
    {
        return -1;
    }

    if (device.mode == MODE_NORMAL) {
        LOG(LOG_SUCCESS, "Found device in normal mode");
        LOG_NO_NEWLINE(LOG_INFO, "Press enter to place device into recovery mode");
        getchar();
        LOG(LOG_INFO, "Placing device into recovery mode");
        LOG(LOG_DEBUG, "Device serial number: %s", device.serialNumber);
        if (enter_recovery() != 0) {
            LOG(LOG_ERROR, "Failed to place device with udid %s into recovery mode", device.serialNumber);
            return -1;
        }
        LOG(LOG_INFO, "Waiting for device to enter recovery mode");
        if (waitForDeviceInMode(&device, MODE_RECOVERY, 20) != 0) {
            LOG(LOG_ERROR, "Device with udid %s failed to enter recovery mode", device.serialNumber);
            return -1;
        }
        LOG(LOG_SUCCESS, "Device entered recovery mode successfully!", device.serialNumber);
    }

    if (device.mode == MODE_RECOVERY) {
        // TODO: DFU helper
        LOG(LOG_INFO, "Please put device into DFU mode manually");
        LOG(LOG_INFO, "Waiting for device to enter DFU mode");
        if (waitForDeviceInMode(&device, MODE_DFU, 30) != 0) {
            LOG(LOG_FATAL, "Could not find device in DFU mode after 30 seconds", device.serialNumber);
            return -1;
        }
        LOG(LOG_SUCCESS, "Device entered DFU mode successfully!");
    }

    // TODO: Check if device is already in pwned DFU mode inside initDFUDevice()
    if (isSerialNumberPwned(device.serialNumber) == 0)
    {
        LOG(LOG_ERROR, "Device is already in pwned DFU mode, not performing exploit");
        return 1;
    }
    else
    {
        LOG(LOG_DEBUG, "Device serial number: %s", device.serialNumber);
    }

    bool pwned;
    bool waitUSB = waitUSBHandle(&device.handle, &checkm8CheckUSBDevice, &pwned);
    if (waitUSB == false)
    {
        LOG(LOG_FATAL, "Failed to wait for USB device");
        return -1;
    }

    

    return 0;
}
