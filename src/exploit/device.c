#include <exploit/device.h>

bool place_device_into_recovery_mode() {
    idevice_t device = NULL;
    lockdownd_client_t lockdown_client = NULL;

    char *udid = args.deviceUDID;
    
    if (!udid) {
        char **deviceIDs;
        int count;

        idevice_error_t listRet = idevice_get_device_list(&deviceIDs, &count);

        if (listRet != IDEVICE_E_SUCCESS)
        {
            LOG(LOG_ERROR, "Failed to get device list.");
            return false;
        }
        if (count == 0)
        {
            return false;
        }
        if (count > 1)
        {
            LOG(LOG_ERROR, "More than one device found, please use the -u argument to specify a UDID.");
            return false;
        }

        udid = deviceIDs[0];
    }

    if (idevice_new(&device, udid) != IDEVICE_E_SUCCESS) {
        return false;
    }

    lockdownd_error_t ret = lockdownd_client_new(device, &lockdown_client, "AchillesRecoveryHelper");

    if (ret != LOCKDOWN_E_SUCCESS) {
        LOG(LOG_ERROR, "Failed to connect to lockdown service.");
        idevice_free(device);
        return false;
    }

    ret = lockdownd_enter_recovery(lockdown_client);
    if (ret == LOCKDOWN_E_SESSION_INACTIVE) {
        lockdownd_client_free(lockdown_client);
        lockdown_client = NULL;
        ret = lockdownd_client_new_with_handshake(device, &lockdown_client, "AchillesRecoveryHelper");
        if (ret != LOCKDOWN_E_SUCCESS) {
            LOG(LOG_ERROR, "Could not connect to lockdownd: %s", lockdownd_strerror(ret));
            return false;
        }
        ret = lockdownd_enter_recovery(lockdown_client);
    }

    if (ret != LOCKDOWN_E_SUCCESS) {
        LOG(LOG_ERROR, "Could not enter recovery mode: %s", lockdownd_strerror(ret));
        return false;
    }

    lockdownd_client_free(lockdown_client);
    idevice_free(device);

    LOG(LOG_SUCCESS, "Device successfully entered recovery mode.");
    return true;
}