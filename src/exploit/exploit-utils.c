#include <exploit/exploit-utils.h>

bool checkm8ExecuteCommand(usb_handle_t *handle, void *request_data, size_t request_len, uint8_t **response, size_t response_len) {
	transfer_ret_t transfer_ret;
	bool ret = false;

	if(waitUSBHandle(handle, NULL, NULL)) {
		if(DFUSendData(handle, request_data, request_len) && (*response = malloc(response_len)) != NULL) {
			if(sendUSBControlRequest(handle, 0xA1, 2, 0xFFFF, 0, *response, response_len, &transfer_ret) && transfer_ret.ret == USB_TRANSFER_OK && transfer_ret.sz == response_len) {
				ret = true;
			} else {
				free(*response);
			}
		}
		closeUSBHandle(handle);
	}
	return ret;
}

// TODO!
// bool checkm8ReadMemory(usb_handle_t *handle, void* address, uint32_t **out, size_t out_len) {
//     uint8_t data[DFU_MAX_TRANSFER_SIZE], *response;
// 	struct {
// 		uint64_t magic, func, x[8];
// 	} exec_cmd;

//     exec_cmd.magic = EXEC_MAGIC;
//     exec_cmd.func = memcpy_addr;
// 	exec_cmd.x[0] = (uint64_t) data;
// }

