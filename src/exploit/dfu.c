#include <exploit/dfu.h>

dfu_serial_t parseSerialNumber(char *serialNumber)
{
    // check if serial number contains "PWND"
    if (isSerialNumberPwned(serialNumber) == 0)
    {
        dfu_serial_t dfuSerial;
        sscanf(serialNumber, "CPID:%x CPRV:%x CPFM:%x BDID:%x ECID:%llx IBFL:%x SRTG:[%s] PWND[%s]", &dfuSerial.cpid, &dfuSerial.cprv, &dfuSerial.cpfm, &dfuSerial.bdid, &dfuSerial.ecid, &dfuSerial.ibfl, dfuSerial.srtg, dfuSerial.pwnd);
        return dfuSerial;
    }
    dfu_serial_t dfuSerial;
    sscanf(serialNumber, "CPID:%x CPRV:%x CPFM:%x BDID:%x ECID:%llx IBFL:%x SRTG:[%s]", &dfuSerial.cpid, &dfuSerial.cprv, &dfuSerial.cpfm, &dfuSerial.bdid, &dfuSerial.ecid, &dfuSerial.ibfl, dfuSerial.srtg);
    return dfuSerial;
}

int isSerialNumberPwned(char *serialNumber)
{
    if (strncmp(serialNumber, "PWND", 4) != 0)
    {
        return 1;
    }

    return 0;
}

int isDFUSerialPwned(dfu_serial_t serial)
{
    if (serial.pwnd[0] == '\0') {
        return 1;
    }
    return 0;
}

int isSupported(int cpid)
{
    // check if CPID is supported
    if (
        cpid == 0x8960 || cpid == 0x7000 || cpid == 0x7001 || cpid == 0x8000 
        || cpid == 0x8001 || cpid == 0x8003 || cpid == 0x8010 || cpid == 0x8011
        || cpid == 0x8012 || cpid == 0x8015
    )
        return 0;
    return 1;
}

bool DFUCheckStatus(const usb_handle_t *handle, uint8_t status, uint8_t state) {
	struct {
		uint8_t status, poll_timeout[3], state, str_idx;
	} dfu_status;
	transfer_ret_t transfer_ret;

	return send_usb_control_request(handle, 0xA1, DFU_GET_STATUS, 0, 0, &dfu_status, sizeof(dfu_status), &transfer_ret) && transfer_ret.ret == USB_TRANSFER_OK && transfer_ret.sz == sizeof(dfu_status) && dfu_status.status == status && dfu_status.state == state;
}

bool DFUSetStateWaitReset(const usb_handle_t *handle) {
	transfer_ret_t transfer_ret;

	return send_usb_control_request_no_data(handle, 0x21, DFU_DNLOAD, 0, 0, 0, &transfer_ret) && transfer_ret.ret == USB_TRANSFER_OK && transfer_ret.sz == 0 && DFUCheckStatus(handle, DFU_STATUS_OK, DFU_STATE_MANIFEST_SYNC) && DFUCheckStatus(handle, DFU_STATUS_OK, DFU_STATE_MANIFEST) && DFUCheckStatus(handle, DFU_STATUS_OK, DFU_STATE_MANIFEST_WAIT_RESET);
}