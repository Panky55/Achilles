#include <exploit/dfu.h>

bool isSerialNumberPwned(char *serialNumber)
{
    extern bool bootingPongoOS;
    return bootingPongoOS ? (strstr(serialNumber, "YOLO") != NULL) : (strstr(serialNumber, "PWND") != NULL);
}

bool isInDownloadMode(char *serialNumber)
{
    return strstr(serialNumber, "YOLO") != NULL;
}

int isDFUSerialPwned(dfu_serial_t serial)
{
    if (serial.pwnd[0] == '\0') {
        return 1;
    }
    return 0;
}

bool isSupported(int cpid)
{
    if (
        cpid == 0x8960 || cpid == 0x7000 || cpid == 0x7001 || cpid == 0x8000 
        || cpid == 0x8001 || cpid == 0x8003 || cpid == 0x8010 || cpid == 0x8011
        || cpid == 0x8012 || cpid == 0x8015
    )
        return true;
    return false;
}

bool DFUCheckStatus(const usb_handle_t *handle, uint8_t status, uint8_t state) {
	struct {
		uint8_t status, poll_timeout[3], state, str_idx;
	} dfu_status;
	transfer_ret_t transfer_ret;

	return sendUSBControlRequest(handle, 0xA1, DFU_GETSTATUS, 0, 0, &dfu_status, sizeof(dfu_status), &transfer_ret) && transfer_ret.ret == USB_TRANSFER_OK && transfer_ret.sz == sizeof(dfu_status) && dfu_status.status == status && dfu_status.state == state;
}

bool DFUSetStateWaitReset(const usb_handle_t *handle) {
	transfer_ret_t transfer_ret;

	return sendUSBControlRequestNoData(handle, 0x21, DFU_DNLOAD, 0, 0, 0, &transfer_ret) && transfer_ret.ret == USB_TRANSFER_OK && transfer_ret.sz == 0 && DFUCheckStatus(handle, DFU_STATUS_OK, DFU_STATE_MANIFEST_SYNC) && DFUCheckStatus(handle, DFU_STATUS_OK, DFU_STATE_MANIFEST) && DFUCheckStatus(handle, DFU_STATUS_OK, DFU_STATE_MANIFEST_WAIT_RESET);
}

#define NOHOME (cpid == 0x8015 || (cpid == 0x8010 && (bdid == 0x08 || bdid == 0x0a || bdid == 0x0c || bdid == 0x0e)))

void DFUHelper(void) {
    step(3, true, "Get ready");
    step(7, true, NOHOME ? "Hold volume down + side button" : "Hold home + power button");
	printf("\r\033[K");
	step(10, true, NOHOME ? "Hold volume down button" : "Hold home button");
}