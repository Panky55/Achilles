#include <exploit/dfu.h>

dfu_serial_t parseSerialNumber(char *serialNumber)
{
    // check if serial number contains "PWND"
    if (isSerialNumberPwned(serialNumber) == 0)
    {
        dfu_serial_t dfuSerial;
        sscanf(serialNumber, "CPID:%x CPRV:%x CPFM:%x BDID:%x ECID:%llx IBFL:%x SRTG:[%s] PWND[%s]", &dfuSerial.cpid, &dfuSerial.cprv, &dfuSerial.cpfm, &dfuSerial.bdid, &dfuSerial.ecid, &dfuSerial.ibfl, dfuSerial.srtg, dfuSerial.pwnd);
        return dfuSerial;
    }
    dfu_serial_t dfuSerial;
    sscanf(serialNumber, "CPID:%x CPRV:%x CPFM:%x BDID:%x ECID:%llx IBFL:%x SRTG:[%s]", &dfuSerial.cpid, &dfuSerial.cprv, &dfuSerial.cpfm, &dfuSerial.bdid, &dfuSerial.ecid, &dfuSerial.ibfl, dfuSerial.srtg);
    return dfuSerial;
}
struct dfu_device_t initDFUDevice(io_service_t device)
{
    dfu_device_t dfuDevice;
    dfuDevice.service = device;
    dfuDevice.serial = parseSerialNumber(getDeviceSerialNumber(device));
    return dfuDevice;
}

int isSerialNumberPwned(char *serialNumber)
{
    if (strncmp(serialNumber, "PWND", 4) != 0)
    {
        LOG(LOG_DEBUG, "Serial number: %s", serialNumber);
        return 1;
    }

    return 0;
}

int isDFUSerialPwned(dfu_serial_t serial)
{
    if (serial.pwnd[0] == '\0') {
        return 1;
    }
    return 0;
}

int isSupported(int cpid)
{
    // check if CPID is supported
    if (
        cpid == 0x8960 || cpid == 0x7000 || cpid == 0x7001 || cpid == 0x8000 
        || cpid == 0x8001 || cpid == 0x8003 || cpid == 0x8010 || cpid == 0x8011
        || cpid == 0x8012 || cpid == 0x8015
    )
        return 0;
    return 1;
}