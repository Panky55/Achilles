#include <exploit/recovery.h>

int enterRecoveryMode() {
	idevice_t device = NULL;
    char **deviceIDs;
    int count;
    idevice_error_t listRet = idevice_get_device_list(&deviceIDs, &count);
    if (listRet != IDEVICE_E_SUCCESS)
    {
        LOG(LOG_ERROR, "Failed to get device list");
        return -1;
    }
    if (count == 0)
    {
        LOG(LOG_ERROR, "No devices found");
        return -1;
    }
    if (count > 1)
    {
        LOG(LOG_ERROR, "More than one device found, AlfieLoader currently does not support multiple device connections at once.");
        return -1;
    }
    char *udid = deviceIDs[0];
	lockdownd_client_t lockdown = NULL;
	if (idevice_new(&device, udid) != IDEVICE_E_SUCCESS) {
		LOG(LOG_ERROR, "Could not connect to device");
		return -1;
	}
	lockdownd_error_t ldret = lockdownd_client_new(device, &lockdown, "AlfieLoader");
	if (ldret != LOCKDOWN_E_SUCCESS) {
		LOG(LOG_ERROR, "Could not connect to lockdownd: %s", lockdownd_strerror(ldret));
		return -1;
	}
	ldret = lockdownd_enter_recovery(lockdown);
	if (ldret == LOCKDOWN_E_SESSION_INACTIVE) {
		lockdownd_client_free(lockdown);
		lockdown = NULL;
		ldret = lockdownd_client_new_with_handshake(device, &lockdown, "AlfieLoader");
		if (ldret != LOCKDOWN_E_SUCCESS) {
			LOG(LOG_ERROR, "Could not connect to lockdownd: %s", lockdownd_strerror(ldret));
			return -1;
		}
		ldret = lockdownd_enter_recovery(lockdown);
	}
	if (ldret != LOCKDOWN_E_SUCCESS) {
		LOG(LOG_ERROR, "Could not trigger entering recovery mode: %s", lockdownd_strerror(ldret));
		return -1;
	}
	lockdownd_client_free(lockdown);
	idevice_free(device);
	return 0;
}

bool sendRecoveryModeCommand(usb_handle_t *handle, char *command) {
	int commandLength = strlen(command);
	if (commandLength >= 0x100) {
		LOG(LOG_ERROR, "Command is too long");
		return false;
	}
	if (commandLength < 1) {
		LOG(LOG_ERROR, "Command is too short");
		return false;
	}
	transfer_ret_t ret;
	sendUSBControlRequest(handle, 0x40, 0, 0, 0, (unsigned char*)command, commandLength + 1, &ret);
	return true;
}