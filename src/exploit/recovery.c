#include <exploit/recovery.h>

// This function was taken from palera1n and adapted for AlfieLoader
int enter_recovery() {
	idevice_t device = NULL;
    char **deviceIDs;
    int count;
    idevice_error_t listRet = idevice_get_device_list(&deviceIDs, &count);
    LOG(LOG_DEBUG, "Found %d devices", count);
    if (listRet != IDEVICE_E_SUCCESS)
    {
        LOG(LOG_ERROR, "Failed to get device list");
        return -1;
    }
    if (count == 0)
    {
        LOG(LOG_ERROR, "No devices found");
        return -1;
    }
    if (count > 1)
    {
        LOG(LOG_ERROR, "More than one device found, AlfieLoader currently does not support multiple device connections at once.");
        return -1;
    }
    char *udid = deviceIDs[0];
	lockdownd_client_t lockdown = NULL;
	if (idevice_new(&device, udid) != IDEVICE_E_SUCCESS) {
		LOG(LOG_ERROR, "Could not connect to device");
		return -1;
	}
	lockdownd_error_t ldret = lockdownd_client_new(device, &lockdown, "AlfieLoader");
	if (ldret != LOCKDOWN_E_SUCCESS) {
		LOG(LOG_ERROR, "Could not connect to lockdownd: %s", lockdownd_strerror(ldret));
		return -1;
	}
	ldret = lockdownd_enter_recovery(lockdown);
	if (ldret == LOCKDOWN_E_SESSION_INACTIVE) {
		lockdownd_client_free(lockdown);
		lockdown = NULL;
		ldret = lockdownd_client_new_with_handshake(device, &lockdown, "AlfieLoader");
		if (ldret != LOCKDOWN_E_SUCCESS) {
			LOG(LOG_ERROR, "Could not connect to lockdownd: %s", lockdownd_strerror(ldret));
			return -1;
		}
		ldret = lockdownd_enter_recovery(lockdown);
	}
	if (ldret != LOCKDOWN_E_SUCCESS) {
		LOG(LOG_ERROR, "Could not trigger entering recovery mode: %s", lockdownd_strerror(ldret));
		return -1;
	}
	lockdownd_client_free(lockdown);
	idevice_free(device);
	return 0;
}

