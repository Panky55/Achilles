#include <exploit/payloads/helpers.h>

// ipwndfu function
void asm_arm64_x7_trampoline(uint64_t address, uint8_t *destination)
{
    assert (address != 0);
    assert (address <= 0xFFFFFFFFFFFFFFFF);

    uint8_t trampoline[16];
    
    // LDR X7, [PC, #OFFSET]
    trampoline[0] = 0x47;
    trampoline[1] = 0x00;
    trampoline[2] = 0x00;
    trampoline[3] = 0x58;
    trampoline[4] = 0xE0;
    trampoline[5] = 0x00;
    trampoline[6] = 0x1F;
    trampoline[7] = 0xD6;

    address = CFSwapInt64HostToLittle(address);
    memcpy(&trampoline[8], &address, 8);

    memcpy(destination, trampoline, 16);

    return;
}